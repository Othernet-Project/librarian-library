// Generated by CoffeeScript 1.10.0
(function(window, $, templates) {
  var DOWN, LEFT, RETURN, RIGHT, UP, buttons, buttonsByName, choices, finishButton, importForm, importFormContainer, importUrl, initialValue, input, ok, onActivate, processing, spinner, stepChoices;
  RETURN = 13;
  LEFT = 37;
  RIGHT = 39;
  UP = 38;
  DOWN = 40;
  processing = false;
  importFormContainer = $('.setup-wizard form');
  importForm = $('#import-step-fields');
  importUrl = importFormContainer.attr('action');
  finishButton = importFormContainer.find('button');
  spinner = templates.spinner;
  ok = templates.okIcon;
  if (!importForm.length) {
    return;
  }
  initialValue = (importForm.find('select')).val();
  stepChoices = $(templates.stepImportChoices);
  importForm.before(stepChoices);
  importForm.remove();
  importForm = null;
  choices = $('#import-choices');
  input = $('#import-chosen-action');
  buttons = choices.find('li');
  buttonsByName = {
    "import": choices.find('#import-import'),
    ignore: choices.find('#import-ignore')
  };
  input.on('change', function(e) {
    var val;
    val = input.val();
    if (!val) {
      return;
    }
    buttons.removeClass('selected');
    return (buttonsByName[val].addClass('selected')).focus();
  });
  onActivate = function(e) {
    var elem, val;
    elem = $(this);
    val = elem.data('action');
    input.val(val);
    input.change();
  };
  choices.on('click', 'li', onActivate);
  choices.on('keydown', 'li', function(e) {
    var code;
    if (processing) {
      return;
    }
    code = e.which;
    if (code === RETURN) {
      onActivate.call(this, e);
    }
    if (([LEFT, UP].indexOf(code)) > -1) {
      input.val('import');
      input.change();
    }
    if (([RIGHT, DOWN].indexOf(code)) > -1) {
      input.val('ignore');
      input.change();
    }
  });
  importFormContainer.on('submit', function(e) {
    var icon, otherAction, res, spinnerIcon;
    e.preventDefault();
    if (processing) {
      return;
    }
    processing = true;
    otherAction = (stepChoices.find('li')).not('.selected');
    otherAction.hide();
    icon = stepChoices.find('.selected .icon');
    spinnerIcon = $(spinner);
    icon.after(spinnerIcon);
    icon.hide();
    finishButton.hide();
    res = $.ajax(importUrl, {
      method: 'POST',
      data: importFormContainer.serialize()
    });
    return res.always(function(data, status) {
      status = status === 'success' ? 200 : data.status;
      if (status >= 400) {
        $('html').html(data.responseText);
        return;
      }
      if (status === 200) {
        spinnerIcon.replaceWith(ok);
        setTimeout(function() {
          return window.location.assign(data);
        }, 2000);
      }
    });
  });
  input.val(initialValue);
  input.change();
})(this, this.jQuery, this.templates);
